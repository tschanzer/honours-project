\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage[a4paper, total={16cm, 23cm}, top=3.5cm]{geometry}
\usepackage[dvipsnames]{xcolor}
\definecolor{linkcolor}{RGB}{51, 54, 142}
\usepackage[colorlinks=true, allcolors=linkcolor]{hyperref}
\usepackage{
    amsmath,
    amssymb,
    amsthm,
    fancyhdr,
    siunitx,
    bm,
    standalone,
    tikz,
    cleveref,
}
\usepackage[
    backend=biber,
    bibstyle=ext-authoryear,
    citestyle=ext-authoryear-comp,
    sorting=nyt,
    uniquename=false,
    maxbibnames=99,
    giveninits=true,
]{biblatex}
\DeclareFieldFormat[article]{volume}{\mkbibbold{#1}}
\DeclareFieldFormat[article]{number}{\mkbibparens{#1}}
\DeclareFieldFormat[article]{pages}{#1}
\renewcommand*{\volnumdelim}{}
\renewbibmacro{in:}{}

\pagestyle{fancy}
\fancyhead{}
\rhead{Appendix}
\renewcommand{\headrulewidth}{0.5pt}

\setlength{\headheight}{15pt}
\setlength\parindent{0pt}
\setlength\parskip{6pt}

\renewcommand{\d}[1]{\mathrm{d}#1}
\newcommand{\diff}[2]{\frac{\mathrm{d} #1}{\mathrm{d} #2}}
\newcommand{\ddiff}[2]{\frac{\mathrm{d}^2 #1}{\mathrm{d} {#2}^2}}
\newcommand{\pdiff}[2]{\frac{\partial #1}{\partial #2}}
\renewcommand\vec{\bm}
\newcommand{\uvec}[1]{\vec{\hat{#1}}}
\newcommand{\grad}{\vec{\nabla}}

\def\equationautorefname~#1\null{%
    (#1)\null
}
\newcommand{\crefrangeconjunction}{--}
\newcommand{\rb}{Rayleigh-B\'{e}nard}
\newcommand{\prandtl}{\ensuremath{\mathrm{Pr}}}

\addbibresource{../references.bib}

\begin{document}
\appendix
\section{The \rb{} equations}
\subsection{Derivation}
We begin with the Navier-Stokes equations for a 2D fluid whose density
depends linearly on temperature in the Boussinesq approximation:
\begin{equation} \label{eqn:ns_vp}
    \left\{ \quad
    \begin{alignedat}{2}
        \text{Momentum:}\quad &&
        \partial_t \vec{u} + (\vec{u} \cdot \grad) \vec{u}
            &= -\frac{1}{\rho_0} \grad p + \nu \nabla^2 \vec{u}
            + g\alpha (T - T_0) \uvec{z} \\
        \text{Thermal advection-diffusion:}\quad &&
        \partial_t T + (\vec{u} \cdot \grad) T &=  D_T \nabla^2 T \\
        \text{Incompressibility:}\quad &&
        \grad \cdot \vec{u} &= 0
    \end{alignedat}
    \right. \quad .
\end{equation}
Here $\vec{u} = (u, 0, w)$ and $\grad = (\partial_x, 0, \partial_z)$.

\autoref{eqn:ns_vp} is cumbersome to solve numerically due
to the presence of the pressure $p$, whose time derivative is not
explicitly specified, and the incompressibility condition, which is not
automatically satisfied by na\"{i}vely time-stepping the momentum
equation.

Instead, one may use the fact that any divergence-free 2D
vector field $\vec{u} = (u, 0, w)$ may be expressed in terms of a scalar
streamfunction $\psi$ as $\vec{u} = (-\partial_z \psi, 0, \partial_x
\psi)$, which automatically satisfies $\grad \cdot \vec{u} = 0$.
This leads to the vorticity-streamfunction representation of the
Navier-Stokes equations, where the vorticity $\vec{\omega} \equiv \grad
\times \vec{u}$ is simply $\nabla^2 \psi ~\uvec{y}$. It may be shown that
\autoref{eqn:ns_vp} is equivalent to
\begin{equation} \label{eqn:ns_omegapsi}
    \left\{ \quad
    \begin{aligned}
        \partial_t \omega + (\vec{u} \cdot \grad) \omega
            &= \nu \nabla^2 \omega - g \alpha \partial_x T \\
        \partial_t T + (\vec{u} \cdot \grad) T &=  D_T \nabla^2 T \\
        \nabla^2 \psi &= \omega
    \end{aligned}
    \right. \quad .
\end{equation}

Our numerical methods require us to recast \autoref{eqn:ns_omegapsi} in flux
form, i.e., $\partial_t \omega = \grad \cdot \vec{F}$ for some vector field
$\vec{F}$ and similarly for $T$. This is easily done using the product
rule for divergence combined with the incomprssibility constraint;
for any scalar function $\psi$,
\[
    \vec{u} \cdot \nabla \psi = \grad \cdot (\vec{u} \psi)
        - \underbrace{(\grad \cdot \vec{u})}_{=0} \psi
        = \grad \cdot (\vec{u} \psi).
\]
This leads to the flux-form Navier-Stokes equations in the
vorticity-streamfunction representation,
\begin{equation} \label{eqn:ns_omegapsi_flux}
    \left\{ \quad
    \begin{aligned}
        \partial_t \omega &= \grad \cdot (\nu \grad \omega - \vec{u} \omega
            - g \alpha T \uvec{x}) \\
        \partial_t T &= \grad \cdot (\nu \grad T - \vec{u} T) \\
        \omega &= \grad \cdot (\grad \psi)
    \end{aligned}
    \right. \quad .
\end{equation}
The dynamical system \autoref{eqn:ns_omegapsi_flux} serves as the object of
our parametrisation study.

\subsection{Nondimensionalisation}
The system \autoref{eqn:ns_omegapsi_flux} contains 12 dimensional parameters
(3 independent variables, 5 dependent variables and 4 constants), spanning 3
physical dimensions (length, time and temperature). According to the
Buckingham $\pi$ theorem, the relationships may be re-expressed in terms of
$12-3=9$ dimensionless parameters. These are found using the method of
repeating variables, where the repeating variables are chosen to be
$\nu$, $g$ and $\alpha$:
\begin{alignat*}{3}
    \tilde{t} &= t \left( \frac{g^2}{\nu} \right)^{1/3},
        & \qquad \tilde{\omega} &= \omega \left( \frac{\nu}{g^2} \right)^{1/3},
        & \qquad \tilde{x} &= x \left( \frac{g}{\nu^2} \right)^{1/3}, \\
    \tilde{z} &= z \left( \frac{g}{\nu^2} \right)^{1/3},
        & \qquad \tilde{u} &= \frac{u}{(\nu g)^{1/3}},
        & \qquad \tilde{w} &= \frac{w}{(\nu g)^{1/3}}, \\
    \tilde{T} &= \alpha T,
        & \qquad \tilde{D_T} &= \frac{D_T}{\nu} \equiv \prandtl^{-1},
        & \qquad \tilde{\psi} &= \frac{\psi}{\nu},
\end{alignat*}
where $\prandtl$ is the Prandtl number.

Rewritten in terms of the dimensionless parameters, the dimensionless form of
\autoref{eqn:ns_omegapsi_flux} is
\begin{subequations} \label{eqn:rbc}
\begin{align}
    \label{eqn:rbc_omega}
    \partial_t \omega &= \grad \cdot (\grad \omega - \vec{u} \omega
        - T \uvec{x}) \\
    \label{eqn:rbc_T}
    \partial_t T &= \grad \cdot (\prandtl^{-1} \grad T - \vec{u} T) \\
    \label{eqn:rbc_poisson}
    \omega &= \grad \cdot (\grad \psi)
\end{align}
\end{subequations}
where we have dropped the tildes.

\subsection{Finite difference discretisation}
While many numerical methods exist for solving partial differential equations,
we opt for a simple finite difference approach in order to facilitate the
separation of the system into ``resolved'' and ``unresolved'' parts later.
Figure \ref{fig:fdgrid} shows the grid that we shall use.
\begin{figure}[ht]
    \centering
    \includestandalone[width=0.6\linewidth]{figures/fdgrid/fdgrid}
    \caption{
        The grid used for the finite difference solution. The key on the
        right indicates which of the three staggered sub-grids each variable
        is defined on.
    }
    \label{fig:fdgrid}
\end{figure}

Define the vorcitity flux in \autoref{eqn:rbc_omega} as
\[
    \vec{F}^\omega = \grad \omega - \vec{u} \omega - T \uvec{x},
\]
with components
\begin{align*}
    F^{\omega x} &= \partial_x \omega - u \omega - T, \\
    F^{\omega z} &= \partial_z \omega - w \omega.
\end{align*}
The variables $u,\omega,T$ are defined on the black grid in
\autoref{fig:fdgrid}. $F^{\omega x}$ is defined on the horizontally staggered
blue grid and always has a half-integer first index. $F^{\omega z}$ is
defined on the vertically staggered green grid, with a half-integer
second index. The reason for the staggering will become clear when
we define the ``resolved'' and ``unresolved'' variables in the next section.
With this in mind, we approximate the derivatives using
central differences, giving
\begin{align*}
    F^{\omega x}_{i+1/2,j}
        &= \frac{\omega_{i+1,j} - \omega_{ij}}{\Delta x}
        - u_{i+1/2,j} \omega_{i+1/2,j} - T_{i+1/2,j}, \\
    F^{\omega z}_{i,j+1/2}
    &= \frac{\omega_{i,j+1} - \omega_{ij}}{\Delta z}
    - w_{i,j+1/2} \omega_{i,j+1/2},
\end{align*}
where $\Delta x$ and $\Delta z$ are the grid spacings. These expressions are
slightly problematic due to terms like $u_{i+1/2,j}$ that are indexed halfway
between grid points, but the issue is easily resolved by approximating these
terms as averages of the neighbouring points:
\begin{equation} \label{eqn:omega_flux}
\begin{aligned}
    F^{\omega x}_{i+1/2,j}
        &= \frac{\omega_{i+1,j} - \omega_{ij}}{\Delta x}
        - \frac{(u_{ij} + u_{i+1,j})(\omega_{ij} + \omega_{i+1,j})}{4}
        + \frac{T_{ij} + T_{i+1,j}}{2}, \\
    F^{\omega z}_{i,j+1/2}
    &= \frac{\omega_{i,j+1} - \omega_{ij}}{\Delta z}
    - \frac{(w_{ij} + w_{i,j+1})(\omega_{ij} + \omega_{i,j+1})}{4}.
\end{aligned}
\end{equation}

Similarly, the components of the temperature flux in \autoref{eqn:rbc_T},
\[
    \vec{F}^T = \prandtl^{-1} \grad T - \vec{u} T,
\]
have the finite difference approximations
\begin{align*}
    F^{Tx}_{i+1/2,j}
        &= \prandtl^{-1} \frac{T_{i+1,j} - T_{ij}}{\Delta x}
        - \frac{(u_{ij} + u_{i+1,j})(T_{ij} + T_{i+1,j})}{4}, \\
    F^{Tz}_{i,j+1/2}
    &= \prandtl^{-1} \frac{T_{i,j+1} - T_{ij}}{\Delta z}
    - \frac{(w_{ij} + w_{i,j+1})(T_{ij} + T_{i,j+1})}{4}.
\end{align*}

Now, the finite difference approximation of the vorticity equation
\autoref{eqn:rbc_omega} becomes
\begin{equation} \label{eqn:omega_tend}
\begin{aligned}
    \partial_t \omega_{ij} &= (\grad \cdot \vec{F}^\omega)_{ij} \\
        &= \frac{F^{\omega x}_{i+1/2,j} - F^{\omega x}_{i-1/2,j}}{\Delta x}
        + \frac{F^{\omega z}_{i,j+1/2} - F^{\omega z}_{i,j-1/2}}{\Delta z},
\end{aligned}
\end{equation}
and similarly for the temperature equation \autoref{eqn:rbc_T},
\begin{equation} \label{eqn:T_tend}
\begin{aligned}
    \partial_t T_{ij} &= (\grad \cdot \vec{F}^T)_{ij} \\
    &= \frac{F^{Tx}_{i+1/2,j} - F^{Tx}_{i-1/2,j}}{\Delta x}
    + \frac{F^{Tz}_{i,j+1/2} - F^{Tz}_{i,j-1/2}}{\Delta z}.
\end{aligned}
\end{equation}

The finite difference form of the Poisson equation \autoref{eqn:rbc_poisson}
is constructed by defining the components of the streamfunction gradient,
\begin{align*}
    D^{\psi x}_{i+1/2,j} &= \frac{\psi_{i+1,j} - \psi_{ij}}{\Delta x}, \\
    D^{\psi z}_{i,j+1/2} &= \frac{\psi_{i,j+1} - \psi_{ij}}{\Delta z}.
\end{align*}
The Poisson equation then becomes
\begin{equation} \label{eqn:poisson_discrete}
    \begin{aligned}
    \omega_{ij}
        = \frac{D^{\omega x}_{i+1/2,j} - D^{\omega x}_{i-1/2,j}}{\Delta x}
        + \frac{D^{\omega z}_{i,j+1/2} - D^{\omega z}_{i,j-1/2}}{\Delta z}.
    \end{aligned}
\end{equation}

\subsection{Resolved and unresolved variables}
So far, we have derived a numerical method to solve the \rb{} system
\autoref{eqn:rbc} on a grid. However, in order to develop a parametrisation, we
will need to express it in terms of a set of large-scale ``resolved'' variables
and a set of sub-grid-scale ``unresolved'' variables. \textcite{zacharuk2018}
demonstrate a simple approach where the resolved variables are average values
of the original variables across several neighbouring grid cells and the
unresolved variables are the corresponding residuals at each point. They
considered a 1D system, but we now generalise the method to 2D.

The structure of the domain is shown in \autoref{fig:grid}, which is
essentially \autoref{fig:fdgrid} with the addition of a new red grid. As
previously discussed, the original variables $\omega, T, \psi$, etc. are
defined on the black grid, which we shall call the ``fine'' grid. Points on the
fine grid are enumerated by lowercase indices $(i,j)$, beginning with $(0,0)$
at the bottom-left corner. We then construct a ``coarse'' grid (red), whose
spacing is $n$ times larger than the fine grid ($n$ is an integer).
Points on this grid are enumerated by uppercase indices $(I,J)$, and the
$(0,0)$ point on the coarse grid lies at $((n-1)/2,(n-1)/2)$ on the fine grid.
\autoref{fig:grid} has $n=4$ as an example.
\begin{figure}[ht]
    \centering
    \includestandalone[width=0.8\linewidth]{figures/grid/grid}
    \caption{
        The grid used for the finite difference solution, showing an example
        where the coarse grid spacing is $n=4$ times larger than the fine
        spacing.
    }
    \label{fig:grid}
\end{figure}

The ``resolved'' variables, denoted by overbars ($\bar{\cdot}$), are defined on
the coarse grid. The value of a resolved variable (e.g., $\bar{\omega}$) at
point $(I,J)$ is the average value of the orignal variable (e.g., $\omega$)
over an $n$-by-$n$ subset of the fine grid, centred on the coarse grid point.
In \autoref{fig:grid} with $n=4$, the value at each red point is the average
across a $4\times4$ set of black points, delimited by dashed red lines.
Mathematically, the resolved vorticity values (for example) are defined as
\begin{equation} \label{eqn:resolved_omega}
    \bar{\omega}_{IJ} = \frac{1}{n^2} \sum_{m,p=-(n-1)/2}^{(n-1)/2}
        \omega_{i(I)+m,j(J)+p},
\end{equation}
where $i(I) = nI + (n-1)/2$ and $j(J) = nJ + (n-1)/2$.

The ``unresolved'' variables, denoted by primes, are defined on the
fine grid. The value of, say, $\omega'_{ij}$ is the residual of $\omega_{ij}$
with respect to the corresponding coarse average value:
\begin{equation} \label{eqn:unresolved_omega}
    \omega'_{ij} = \omega_{ij} - \bar{\omega}_{I(i),J(j)},
\end{equation}
where $I(i) = \lfloor i/n \rfloor$ and $J(j) = \lfloor j/n \rfloor$
($\lfloor \cdot \rfloor$ is the floor function.)

The first step is to take the time derivative of \autoref{eqn:resolved_omega}
and substitute the expression for $\partial_t \omega_{ij}$ from
\autoref{eqn:omega_tend}:
\begingroup
\allowdisplaybreaks
\begin{align*}
    \partial_t \bar{\omega}_{IJ}
        &= \frac{1}{n^2} \sum_{m,p=-(n-1)/2}^{(n-1)/2}
            \partial_t \omega_{i(I)+m,j(J)+p} \\
        &= \frac{1}{n^2} \sum_{m,p=-(n-1)/2}^{(n-1)/2} \left[
            \frac{
                F^{\omega x}_{i(I)+m+1/2,j(J)+p}
                - F^{\omega x}_{i(I)+m-1/2,j(J)+p}
            }{\Delta x} \right. \\
        &\phantom{{}=\frac{1}{n^2} \sum_{m,p=-(n-1)/2}^{(n-1)/2} \left[\right.}
            \left. + \frac{
                F^{\omega z}_{i(I)+m,j(J)+p+1/2}
                - F^{\omega z}_{i(I)+m,j(J)+p-1/2}
            }{\Delta z}
            \right].
\end{align*}
\endgroup
The utility of the staggered grids now becomes clear; the fluxes in the
interior are cancelled, leaving only the fluxes at the boundaries:
\begingroup
\allowdisplaybreaks
\begin{align} \allowdisplaybreaks
    \nonumber
    \partial_t \bar{\omega}_{IJ}
    &= \frac{1}{n^2} \left[ \sum_{p=-(n-1)/2}^{(n-1)/2}
        \frac{
            F^{\omega x}_{i(I)+n/2,j(J)+p}
            - F^{\omega x}_{i(I)-n/2,j(J)+p}
        }{\Delta x} \right. \\
    \nonumber
    &\phantom{{}= \frac{1}{n^2} \left[\right.}
        \left. + \sum_{m=-(n-1)/2}^{(n-1)/2} \frac{
            F^{\omega z}_{i(I)+m,j(J)+n/2}
            - F^{\omega z}_{i(I)+m,j(J)-n/2}
        }{\Delta z}
        \right]. \\
    \label{eqn:omegabar_tend}
    &\begin{aligned}
        &= \frac{1}{n^2} \sum_{m=-(n-1)/2}^{(n-1)/2} \left[
            \frac{
                F^{\omega x}_{i(I)+n/2,j(J)+m}
                - F^{\omega x}_{i(I)-n/2,j(J)+m}
            }{\Delta x} \right. \\
        &\phantom{{}=\frac{1}{n^2} \sum_{m=-(n-1)/2}^{(n-1)/2} \left[\right.}
            \left. + \frac{
                F^{\omega z}_{i(I)+m,j(J)+n/2}
                - F^{\omega z}_{i(I)+m,j(J)-n/2}
            }{\Delta z}
            \right].
    \end{aligned}
\end{align}
\endgroup
The first term in the sum is the net horizontal flux into the $n \times n$
region belonging to $\bar{\omega}_{IJ}$, and the second term is the net
vertical flux. We have essentially employed a discrete form of the divergence
theorem.

The next step, which we do not write out explicitly, is to substitute
the expressions \autoref{eqn:omega_flux} for the fluxes into
\autoref{eqn:omegabar_tend}. This expresses $\partial_t \bar{\omega}_{IJ}$
in terms of $\omega,u,w,T$. Finally, inserting the decompositions
$\omega = \bar{\omega} + \omega'$, $u = \bar{u} + u'$, etc. leads to
an expression for $\partial_t \bar{\omega}_{IJ}$ that has the form
\begin{equation} \label{eqn:omegabar_tend_decomp}
    \partial_t \bar{\omega}_{IJ}
        = S_{\bar{\omega}}(\bar{\omega},\bar{u},\bar{w},\bar{T})
        + C_{\bar{\omega}}(\omega',u',w',T')
        + X_{\bar{\omega}}(\bar{u},u',\bar{w},w').
\end{equation}
The first term, $S_{\bar{\omega}}$, describes the self-interactions of the
resolved variables. The second term, $C_{\bar{\omega}}$, couples the resolved
variables to the unresolved ones. The third term, $X_{\bar{\omega}}$,
consists of cross terms such as $\bar{u}\omega'$ (arising from the nonlinear term
$(u_{ij} + u_{i+1,j})(\omega_{ij} + \omega_{i+1,j})$ in
\autoref{eqn:omega_flux}) that cannot be separated into self-interaction and
coupling terms. The aim of parametrisation is to estimate $C_{\bar{\omega}}$
and $X_{\bar{\omega}}$, only having knowledge of the resolved variables.

A similar decomposition can be performed for the temperature equation
\autoref{eqn:rbc_T}, giving an expression of the form
\begin{equation} \label{eqn:Tbar_tend_decomp}
    \partial_t \bar{T}_{IJ}
        = S_{\bar{T}}(\bar{\omega},\bar{u},\bar{w},\bar{T})
        + C_{\bar{T}}(\omega',u',w',T')
        + X_{\bar{T}}(\bar{u},u',\bar{w},w').
\end{equation}

Like \autoref{eqn:omegabar_tend_decomp}, the Poisson equation for
$\bar{\omega}$ can be expressed as a net flux,
\begin{align*}
    \bar{\omega}_{IJ}
    &= \frac{1}{n^2} \sum_{m=-(n-1)/2}^{(n-1)/2} \left[
        \frac{
            D^{\psi x}_{i(I)+n/2,j(J)+m}
            - D^{\psi x}_{i(I)-n/2,j(J)+m}
        }{\Delta x} \right. \\
    &\phantom{{}=\frac{1}{n^2} \sum_{m=-(n-1)/2}^{(n-1)/2} \left[\right.}
        \left. + \frac{
            D^{\psi z}_{i(I)+m,j(J)+n/2}
            - D^{\psi z}_{i(I)+m,j(J)-n/2}
        }{\Delta z}
        \right],
\end{align*}
which can also be reduced to self-interaction and coupling terms:
\begin{equation} \label{eqn:poisson_decomp}
    \bar{\omega}_{IJ} = S_{\bar{\psi}}(\bar{\psi}) + C_{\bar{\psi}}(\psi').
\end{equation}
There is no cross-term for the Poisson equation.

\subsection{Solution algorithm}
Once appropriate boundary conditions have been formulated,
\labelcref{eqn:omega_tend,eqn:T_tend,eqn:poisson_discrete} may be solved
directly to obtain a ``truth'' solution on the fine grid. Given the fields
$\omega,u,w,T$ at the current time step, the values at the next time step
are determined by the following procedure:
\begin{enumerate}
    \item Using \autoref{eqn:omega_tend}, update $\omega$ at each point
        with the simple forward Euler method
        $\omega_{ij}(t+\Delta t) = \omega_{ij}(t)
        + \Delta t \cdot \partial_t \omega_{ij}(t)$.
    \item Using \autoref{eqn:T_tend}, update $T$ at each point.
    \item Given $\omega(t+\Delta t)$ use standard numerical linear algebra
        methods to solve the Poisson equation \autoref{eqn:poisson_discrete}
        for $\psi(t+\Delta t)$.
    \item Calculate $u(t+\Delta t) = -\partial_z \psi(t+\Delta t)$
        and $w(t+\Delta t) = \partial_x \psi(t+\Delta t)$.
\end{enumerate}

The parametrised solution for the resolved variables is similar, but
requires additional estimation steps:
\begin{enumerate}
    \item Estimate the coupling terms $C_{\bar{\omega}}$ and $X_{\bar{\omega}}$
        that appear in \autoref{eqn:omegabar_tend_decomp}.
    \item Using \autoref{eqn:omegabar_tend_decomp}, update $\bar{\omega}$
        at each point.
    \item Estimate the coupling terms $C_{\bar{T}}$ and $X_{\bar{T}}$
        that appear in \autoref{eqn:Tbar_tend_decomp}.
    \item Using \autoref{eqn:Tbar_tend_decomp}, update $\bar{T}$ at each point.
    \item Estimate the coupling term $C_{\bar{\psi}}$
        that appears in \autoref{eqn:poisson_decomp}.
    \item Given $\bar{\omega}(t+\Delta t)$, solve the Poisson equation
        \autoref{eqn:poisson_decomp} for $\psi(t+\Delta t)$.
    \item Calculate
        $\bar{u}(t+\Delta t) \approx -\partial_z \bar{\psi}(t+\Delta t)$
        and $\bar{w}(t+\Delta t) \approx \partial_x \bar{\psi}(t+\Delta t)$.
\end{enumerate}

\emergencystretch=5em
\printbibliography

\end{document}
